# 沪深两所行情相关信息整理

#### ChangeLog (Desc by date)
 
| Date | Reviser | Description |
| ------ | --- | ----- |
| 2024/07/21  | huaisy  | 创建 |

#### Reference
 
| 序号 | 文件名 | 最新修订日期 | 文档链接 |
| ------ | --- | ----- | ---- |
| 1 | 上海证券交易所LDDS系统竞价Level-2行情接口说明书  | 2024/07/01 | <https://www.sseinfo.com/services/assortment/document/> |
| 2 | 上海证券交易所 LDDS系统静态数据接口说明书 | 2023/10/30 | <https://www.sseinfo.com/services/assortment/document/> |



## 1.概述

&ensp;在阅读沪深交易所关于行情的文档后，对两所发布行情认识逐渐加深。所谓行情，是由交易所作为源头发布，经由行情商等机构接取，最后流向下游按需使用。根据两所业务类型，行情种类丰富多样。其中，以竞价Level-2行情作为本次主要研究对象；在竞价产品中，又以股票产品为切入点，以更快地理解并参与生产。

&ensp;该报告中的内容结合了公开文档和个人认知，仅作为团队内分享用。

## 2.行情知识梳理

### 2.1.行情分类

&ensp;主观来看，沪深交易所的文档能力亦有差异。上交所通过行情发布系统LDDS说明+该系统按发布产品展开的接口说明+行情数据产品说明书+市场参与者接口等众多文档，互相之间引用重叠，达成了“孤木难支，众擎易举”的效果。深交所则按照行情发布方式（Binary|STEP）编写文档，涵盖如何接入、提供哪些服务、接口定义、数据字典等内容，对于想要更快了解心中困惑的人而言，简直是“有心之云，及时之雨”。

&ensp;行情分类可以有以下方式：
  - 按发布类型
    - 静态文件
    - 动态数据
  - 按业务内容
    - 市场状态
    - 公告
    - 具体业务（竞价、债券等，篇幅原因不展开）
  - 按发布逻辑
    - 快照：按照类别频率发布
    - 逐笔：频道内序号递增发布
  - 其他（非主要研究对象）

#### 2.1.1.静态文件
&ensp;静态文件类别较多，本节主要针对交易所生成的交易参考信息展开。
1. 上交所静态文件
    1. 概况
    上交所静态文件均为T日发送，大部分文件内容固定不变，也有特殊的如竞价行情文件、债券行情文件实时增长。
    2. 时间表
        - 8:00
            - 融资融券文件 `dbpMMDD.txt`
            - 重点指数表现文件 `zsbxYYMMDD.txt`
            - 产品基础信息第二版第一批次文件 `cpxx0201MMDD.txt`
            - 产品基础信息第二版第二批次文件 `cpxx0202MMDD.txt`
            - 产品非交易基础信息文件 `fjyYYYYMMDD.txt`
            - 基金非交易基础信息文件 `jfjyYYYYMMDD.xml`
            - 债券非交易基础信息文件 `zfjyYYYYMMDD.xml`
            - 竞价行情文件 `mktdt00.txt`
            - 债券行情文件 `mktdt02.txt`
            - 沪伦通收盘行情文件 `LSE_EODSUMMARY_<YYYYMMDD>.CSV`
            - 沪伦通GDR基本信息增量文件 `se038gdrjbxxYYYYMMDD001.txt`
            - 产品简称文件 `cpjcMMDD.txt`
            - 定向可转债成交明细信息文件 `se060dxkzzcjYYYYMMDD001.txt`
            - 基金及公募REITs业务参数公告文件 `sfpm01MMDD.txt`
            - 期权基础信息 `reff03mmdd.txt`
            - 期权基础信息第二版文件 `reff0302YYYYMMDD.xml`
            - 期权组合策略文件 `zhcl03MMDD.txt`
            - 交易参与人清单 `se015jycyrYYYYMMDD001.txt`
            - 交易员清单 `se015jyyYYYYMMDD001.txt`
            - 国际化产品信息文件 `ifjyyyyymmdd.xml`
            - 债券产品信息文件 `archive_bondinfoYYYYMMDD.zip`
            - 证券信息参考文件 `se015zqxxyyyymmdd002.txt`
            - 国债利息文件 `gzlx.MDD`
        - 9:30
            - 沪伦通GDR基本信息全量文件 `se060gdrjbxxYYYYMMDD001.txt`
        - 16:15
            - 期权收盘价格 `clpr03mmdd.txt`
        - 17:30
            - 主板交易公开信息公告文件 `jygkxxMMDD.txt`
            - 科创板交易公开信息公告文件 `jygkxx02MMDD.txt`
2. 深交所静态文件
    1. 概况
    
    

### 2.2.行情数据通路

&ensp;本节以上交所行情为例，阐述个人对于行情数据产生通路的理解。

&ensp;行情数据的源头是位于后台的交易系统。在接收参与者的委托，经业务处理撮合成交后，后台业务系统的内存中，相关参考数据发生改变，并按照行情发布的逻辑生成消息包，发往行情中心（或行情网关）。与此同时，数据也经由技术公司转交给了信息公司，前者生产行情，后者负责对接市场发布。信息公司接到行情源数据后，按类型接口对接入行情的参与者或行情商发布行情。

## 3.行情数据结构

### 3.1.逐笔成交
通过比对两所的逐笔成交接口和公司使用的数据结构，产生的问题：
* [x] TODO: 业务委托号指什么，为什么有成交编号还不够，还需要使用“业务委托号（沪）”这个字段？
————答：BizIndex，逐笔委托和逐笔成交合并后的连续编号。
* [ ] TODO: 深交所的逐笔成交为什么还有第二交易所订单编号、竞买成交方式、成交边际价格？

**parquet文件初探**

`L2TRADE.journal`
```
Data columns (total 17 columns):
 #   Column          Dtype  
---  ------          -----  
 0   source          int8   
 1   nano            int64  
 2   msg_type        int8   
 3   extra_nano      int64  
 4   err_id          int32  
 5   InstrumentCode  object 
 6   TradeTime       int64  
 7   TradeIndex      int64  
 8   BizIndex        int64  
 9   AskNo           int64  
 10  BidNo           int64  
 11  Price           float64
 12  Volume          float64
 13  ChannelNo       int32  
 14  ExchangeID      int16  
 15  BSFlag          int8   
 16  TradeType       int8
```
其中最好奇的是`ChannelNo`字段，于是把所有通道和记录数都打出来，结果是11-6、20、20xx，怀疑通道号可能有特殊含义，但是目前在文档中没找到答案，每个数字代表什么。
* [ ] TODO: 通道号是怎么定义的？
筛选通道号为1的记录：
```
       source                 nano  msg_type  extra_nano  err_id InstrumentCode          TradeTime  TradeIndex  BizIndex  AskNo  BidNo  Price  Volume  ChannelNo  ExchangeID  BSFlag  TradeType
40231       1  1720401900000000000       105           0       0      600733.SH  20240708092500000       10278     10278   9343    571   9.09   100.0          1           1      50         50
40234       1  1720401900000000000       105           0       0      600733.SH  20240708092500000       10279     10279   9343   6527   9.09   500.0          1           1      50         50
40237       1  1720401900000000000       105           0       0      600733.SH  20240708092500000       10280     10280  14254   6527   9.09   900.0          1           1      50         50
40240       1  1720401900000000000       105           0       0      600733.SH  20240708092500000       10281     10281  14254   9145   9.09   100.0          1           1      50         50
40243       1  1720401900000000000       105           0       0      600733.SH  20240708092500000       10282     10282  18484   9145   9.09   100.0          1           1      50         50
```

### 3.2.逐笔委托
* 深交所还有市价现价等其他的字段，但是可能没用。
* 上交所结构同深交所。

### 3.3.行情快照
用union可以容许十档有两种表现形式。

### 3.4.指数快照
无特别





=====
以下内容为临时笔记，还未经过整理。
```
上交所使用LDDS发布行情，业务范围包括上交所行情、外部实时和外部收盘行情。本文档主要针对上交所行情展开，根据其业务可分为：
* 上交所静态文件
* 竞价和债券（Level-1行情、Level-2行情）
* 股票期权
* 固定收益
* 综合业务
* 主参考数据

## 2.上交所行情
### 2.1.上交所静态文件
&ensp;静态数据除上交所静态文件外，还包含中证指数公司债券估值文件、港股通参考数据文件、股票期权静态文件以及巴交所指数收盘文件。
&ensp;上交所发布的静态文件中，常见的有产品基础信息cpxx、竞价行情文件mktdt00.txt、债券行情文件mktdt02.txt等。
* [ ] TODO: 为什么mktdt00.txt是静态文件？

注：以上静态文件根据生成时间，分时段获取。

### 2.2.竞价和债券
#### 2.2.1.Level-1
&ensp;Level-1定义为基础行情，有三种发布形式：
* 文件行情：竞价mktdt00.txt，债券mktdt02.txt
* Binary流行情：利于标准化的二进制数据
* FAST流行情：对STEP数据进行FAST编码

&ensp;实时数据（静态数据参考2.1.节中的静态文件）分为：
* 集合竞价数据
* 证券快照数据（买卖5档）
* 指数快照数据

#### 2.2.2.Level-2
&ensp;Level-2行情是增值行情，具有更多盘口数据、逐笔等细节，根据数据类别可分为快照、逐笔成交（盘后固定价格）和逐笔合并，根据数据子类别可细分为市场、指数行情、竞价行情等。

注：以上数据子类分时段下发。
1. 快照类
  * 更新频率：
    * 变化全量快照：3秒/幅，若3秒内无变化则顺延到下一周期，直到周期全量
    * 周期全量快照：30秒/幅，盘后固定价格6秒/幅，无论数据有误变化均按时发布
  * 竞价行情快照提供10档深度+买卖一档上的前50笔委托数量等数据
  * 盘后固定价格交易行情15:00开始，每6秒一次全量，每3秒一次增量
2. 逐笔类
  * 与快照类无先后
  * 每个成交通道的成交序号连续，可用于丢包的判断
  * 逐笔包含新增委托、删除委托（撤单）、产品状态订单及成交
  * 集合竞价及停牌期间不发送逐笔，到结束时统一发送，顺序为委托->成交->产品状态
  * 同一笔委托的剩余委托订单只发一次
  * 若3秒内通道无逐笔，则推送当前最大逐笔序号

### 2.3.其他业务（待补充）
```


